<!doctype html>
<html>
<head>
    <title>Shell Facebook Likes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400, 400italic|Montserrat:400, 700);
    html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
      margin: 0;
      padding: 0;
      border: 0;
      font: inherit;
      font-size: 100%;
      vertical-align: baseline;
    }
    html {
      line-height: 1;
    }
    ol, ul {
      list-style: none;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
    }
    caption, th, td {
      text-align: left;
      font-weight: normal;
      vertical-align: middle;
    }
    q, blockquote {
      quotes: none;
    }
    q:before, q:after, blockquote:before, blockquote:after {
      content:"";
      content: none;
    }
    a img {
      border: none;
    }
    article, aside, details, figcaption, figure, footer, header, hgroup, main, menu, nav, section, summary {
      display: block;
    }
    * {
      box-sizing: border-box;
    }
    body {
      color: #333;
      -webkit-font-smoothing: antialiased;
      font-family:"Montserrat", sans-serif;
      padding: 2%;
    }
    .wrap {
      width: 50%;
      margin: 0 auto;
    }
    h1 {
      font-family:"Montserrat", sans-serif;
      font-weight: bold;
      text-align: center;
      font-size: 1.5em;
      padding: .5em 0;
      margin-bottom: 1em;
      border-bottom: 1px solid #dadada;
      letter-spacing: 3px;
      text-transform: uppercase;
    }
    ul li {
      line-height: 2;
      font-weight: bold;
      font-family:"Montserrat", sans-serif;
      font-size: .85em;
      text-transform: uppercase;
      clear: both;
    }
    ul li:before {
      content:"\2023";
      padding: 0 1em 0 0;
    }
    .bar {
      background: #e74c3c;
      width: 0;
      margin: .25em 0;
      color: #fff;
      position: relative;
      transition: width 2s, background .2s;
      clear: both;
    }
    .bar:nth-of-type(2n) {
      background: #ed7669;
    }
    .bar .label {
      font-size: .75em;
      padding: 1em;
      background: #3d3d3d;
      width: 12em;
      display: inline-block;
      position: relative;
      z-index: 2;
      font-weight: bold;
      font-family:"Montserrat", sans-serif;
    }
    .bar .label.light {
      background: #575757;
    }
    .count {
      position: absolute;
      right: .25em;
      top: .75em;
      padding: .15em;
      font-size: .75em;
      font-weight: bold;
      font-family:"Montserrat", sans-serif;
    }
    </style>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
</head>
<body>
    <div class="wrap">
      <h1>Shell Marathon Facebook Likes</h1>

      <div class="holder">

      </div>
    </div>

    <script type="text/javascript">
    function fetchLikeCount(url){
      return $.Deferred(function(defer){
          $.ajax({
              dataType: 'jsonp',
              url: 'https://api.facebook.com/method/fql.query?callback=callback',
              data: {
                  query: 'SELECT like_count FROM link_stat WHERE url="' + url + '"',
                  format: 'JSON'
              }
          }).then(function(res){
              try{
                  var count = res[0].like_count;
                  defer.resolve(count);
              }catch(e){
                  reject();
              }
          }, reject);
          function reject(){
              defer.reject(';(');
          };
      }).promise();
    };

    $(function() {
      // team information
      var teams = [
        {
          url: 'https://www.facebook.com/University-of-Alberta-EcoCar-Team-287163227967047',
          name: 'Ualberta EcoCar',
          likes: 0
        },
        {
          url: 'https://www.facebook.com/utsupermileage/',
          name: 'UofT Supermilage',
          likes: 0
        },
        {
          url: 'https://www.facebook.com/ubcst/',
          name: 'UBC Supermileage',
          likes: 0
        }
      ];

      var max_likes = 0;

      var setLikes = function(i, likes) {
        teams[i].likes = likes;
        if(res > max_likes) max_likes = res;
        console.log(likes);
      };

      // get likes
      for( var i=0; i<teams.length; i++) {
        fetchLikeCount(teams[i].url).always(function(res) {
          setLikes(i, res);
        });
        //setLikes(i, res);
        //console.log(i);
      }


      // add html
      Promise.all(teams).then(function() {
        teams.forEach(function(team) {
          //console.log(team.likes);
          $(".holder").append('<div class="bar cf" data-percent="' + 23 + '%"><span class="label">' + team.name + '</label></div>');
        });
      });

    });
    </script>
</body>
</html>
